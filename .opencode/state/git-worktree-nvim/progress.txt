# Progress Log
PRD: git-worktree-nvim
Started: 2026-01-16

## Codebase Patterns
- **Module structure**: Each module returns a table M with public functions
- **Type safety**: LuaCATS annotations in types.lua, @class and @param tags
- **Config pattern**: config.setup() validates and deep extends defaults

---
<!-- Task logs below - APPEND ONLY -->

## Task - setup-1
- Created plugin directory structure: lua/git-worktree/, plugin/
- Implemented lua/git-worktree/init.lua with setup() function that delegates to config
- Implemented lua/git-worktree/config.lua with defaults, validation via vim.validate()
- Implemented lua/git-worktree/types.lua with LuaCATS annotations for Worktree, hooks, options
- Implemented plugin/git-worktree.lua registering :Worktree command
- Verified require('git-worktree') loads without error via nvim --headless
- Files changed: lua/git-worktree/{init,config,types}.lua, plugin/git-worktree.lua
- **Learnings**: vim.tbl_deep_extend merges configs, vim.validate checks types at runtime

## Task - git-1
- Created lua/git-worktree/git.lua with git command wrapper functions
- Implemented worktree_list() returning stdout from `git worktree list --porcelain`
- Implemented worktree_add(path, branch, opts) with create_branch support
- Implemented worktree_remove(path, opts) with force option
- Implemented is_dirty(path) checking `git -C <path> status --porcelain`
- Implemented get_git_root() returning repo root from `git rev-parse --show-toplevel`
- All functions use vim.system() synchronously via :wait()
- All functions check exit codes and return errors on failure
- Files changed: lua/git-worktree/git.lua
- **Learnings**: vim.system() returns vim.SystemCompleted with code, stdout, stderr fields; use :wait() for sync execution

## Task - core-1
- Created lua/git-worktree/worktree.lua with parse() and list() functions
- parse() parses `git worktree list --porcelain` output into Worktree objects
- Handles all porcelain fields: worktree, HEAD, branch, detached, bare, locked, prunable
- branch field extracts name from refs/heads/X format, nil for detached HEAD
- is_current determined by comparing resolved paths (vim.fn.resolve) to handle symlinks
- Added list() function to init.lua that delegates to worktree.list()
- Tested with both normal branch and detached HEAD worktrees
- Files changed: lua/git-worktree/worktree.lua, lua/git-worktree/init.lua
- **Learnings**: Porcelain format is line-based with blank line separators; vim.fn.resolve canonicalizes paths for comparison

## Task - core-2
- Implemented create() API in lua/git-worktree/worktree.lua with async (callback) and sync modes
- create() accepts CreateWorktreeOpts: branch (required), path, create_branch, switch
- Prompts for path via vim.ui.input() if not provided, defaults to ../<branch-name> from git root
- Returns Worktree object on success, nil + error on failure
- Calls on_create hook if configured in setup()
- Switches to new worktree by default (switch = true) via pcall to avoid circular dependency
- Uses vim.fn.resolve() for path comparison to handle symlinks (/tmp -> /private/tmp on macOS)
- Added create() to public API in lua/git-worktree/init.lua
- Tested: existing branch, create_branch=true, on_create hook
- Files changed: lua/git-worktree/worktree.lua, lua/git-worktree/init.lua
- **Learnings**: vim.ui.input() requires async callback pattern; pcall protects against missing dependencies during development; symlink resolution critical for macOS /tmp paths

## Task - core-3
- Verified lua/git-worktree/buffer.lua already implemented with save_all() and repoint() functions
- save_all() iterates through all buffers, saves only modified normal file buffers (buftype=='')
- Uses vim.api.nvim_get_option_value() to check modifiable and modified state
- repoint(old_root, new_root) canonicalizes paths with vim.fn.resolve() to handle symlinks
- Filters buffers by buftype to skip terminals, quickfix, help, etc
- Calculates relative paths and reconstructs absolute paths in new worktree
- Checks vim.fn.filereadable() before repointing; closes buffers for missing files
- Notifies user when closing buffers for files not in new worktree
- Files: lua/git-worktree/buffer.lua
- **Learnings**: nvim_get_option_value() preferred over deprecated buf_get_option; vim.startswith() cleaner for path prefix checks
